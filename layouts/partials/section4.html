{{- $section := .Site.Params.section4 }}
<section class="section" id="section4" style="background-color: #1e242c;">
  <div class="container has-text-centered">
    <h2 class="title is-2 has-text-white">{{ $section.title }}</h2>
    <h3 class="subtitle is-5 has-text-grey-light">{{ $section.subtitle }}</h3>

    <!-- Carousel wrapper -->
    <div style="overflow: hidden; position: relative; margin-top: 2rem;">
      <!-- Carousel track -->
      <div id="carousel-track" style="display: flex; transition: transform 0.6s ease; align-items: stretch;">
        {{ range $index, $client := $section.clients }}
          <div class="testimonial-card" style="flex: 0 0 33.3333%; padding: 1rem; box-sizing: border-box; display: flex; flex-direction: column;">
            <div class="box" style="background-color: #2b343d; color: white; display: flex; flex-direction: column; justify-content: space-between; height: 100%;">
              <figure class="image is-96x96 is-inline-block mb-4" style="margin-left: auto; margin-right: auto;">
                <img class="is-rounded" src="{{ printf "images/clients/%s" $client.img | relURL }}" alt="{{ $client.name }}" onload="setCardHeight()">
              </figure>
              <p class="title is-5 has-text-white mb-1">{{ $client.name }}</p>
              <p class="is-size-6 has-text-grey-light">{{ $client.job }}, {{ $client.company }}</p>
              <p class="has-text-grey-lighter mt-3">"{{ $client.quote }}"</p>
            </div>
          </div>
        {{ end }}
      </div>
    </div>
  </div>

  <script>
    window.onload = function() {
      const track = document.getElementById("carousel-track");
      const cards = document.querySelectorAll(".testimonial-card");
      const visible = 3;
      let currentIndex = 0;

      // Clone first 'visible' cards for looping
      for (let i = 0; i < visible; i++) {
        const clone = cards[i].cloneNode(true);
        track.appendChild(clone);
      }

      // Function to set all cards to the height of the tallest one
      function setCardHeight() {
        let maxHeight = 0;
        
        // Ensure all cards have the same height
        cards.forEach(card => {
          card.style.height = 'auto'; // Reset height before measuring
          const cardHeight = card.offsetHeight;
          if (cardHeight > maxHeight) {
            maxHeight = cardHeight;
          }
        });

        cards.forEach(card => {
          card.style.height = maxHeight + 'px'; // Set all cards to the tallest height
        });
      }

      // Call the function to set heights after images have loaded
      setCardHeight();

      // Recalculate heights whenever the window is resized (optional)
      window.addEventListener('resize', function() {
        setCardHeight();
      });

      function slideCarousel() {
        currentIndex++;
        track.style.transform = `translateX(-${(100 / visible) * currentIndex}%)`;

        // Reset after last slide
        if (currentIndex >= cards.length) {
          setTimeout(() => {
            track.style.transition = 'none';
            track.style.transform = 'translateX(0)';
            currentIndex = 0;
            void track.offsetWidth; // Force reflow
            track.style.transition = 'transform 0.6s ease';
          }, 600);
        }
      }

      setInterval(slideCarousel, 4000); // every 4 seconds
    };
  </script>
</section>
